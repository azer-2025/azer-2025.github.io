{"title":"SSE","uid":"6f3bec25b72da0f2f917f80df8077d15","slug":"SSE","date":"2025-11-14T13:54:56.000Z","updated":"2025-11-14T13:57:25.833Z","comments":true,"path":"api/articles/SSE.json","keywords":"VUE、Python、JAVA","cover":"/medias/SSE.png","content":"<h1 id=\"一、什么是SSE？SSE为何突然爆火？\"><a href=\"#一、什么是SSE？SSE为何突然爆火？\" class=\"headerlink\" title=\"一、什么是SSE？SSE为何突然爆火？\"></a>一、什么是SSE？SSE为何突然爆火？</h1><p>你有没有想过，为什么 ChatGPT 的回答能逐字逐句地“流”出来？</p>\n<p>这一切的背后，都离不开一项关键技术——<strong>SSE（Server-Sent Events）</strong>！</p>\n<h2 id=\"1-1、什么是-SSE？\"><a href=\"#1-1、什么是-SSE？\" class=\"headerlink\" title=\"1.1、什么是 SSE？\"></a>1.1、什么是 SSE？</h2><p>SSE（Server-Sent Events）是一种基于 HTTP 协议的<strong>服务器推送技术</strong>，允许服务端主动向客户端发送数据流。</p>\n<p><strong>SSE 可以被理解为 HTTP 的一个扩展或一种特定用法。它不是一个全新的、独立的协议，而是构建在标准 HTTP&#x2F;1.1 协议之上的技术。</strong></p>\n<p>SSE 就像是服务器打开了一个“单向数据管道”，服务器通过HTTP 扩展 可以持续不断地流向浏览器，无需客户端反复发起请求。</p>\n<p>其实很简单的： SSE &#x3D; HTTP 扩展字段 + Keepalive 长连接。</p>\n<p>SSE 提供了一种简单、可靠的方式来实现服务器向客户端的实时数据推送。它非常适合通知、实时数据更新、日志流和类似 ChatGPT 的逐字输出场景。如果你只需要单向通信，SSE 往往是比 WebSocket 更简单、更轻量的选择。</p>\n<p>SSE 适用于服务器主动向客户端推送数据的场景，如实时通知、动态更新等。</p>\n<p>所以，目前 几乎所有主流浏览器都原生支持SSE。</p>\n<h2 id=\"1-2-SSE-Server-Sent-Events-诞生背景\"><a href=\"#1-2-SSE-Server-Sent-Events-诞生背景\" class=\"headerlink\" title=\"1.2 SSE (Server-Sent Events) 诞生背景\"></a>1.2 SSE (Server-Sent Events) 诞生背景</h2><h3 id=\"短轮询、长轮询、Flash-、-WebSocket\"><a href=\"#短轮询、长轮询、Flash-、-WebSocket\" class=\"headerlink\" title=\"短轮询、长轮询、Flash 、 WebSocket\"></a>短轮询、长轮询、Flash 、 WebSocket</h3><p>在 SSE 技术出现之前，Web 应用要实现服务器向客户端的实时数据推送，主要依赖以下几种技术，但它们都存在明显的缺陷：</p>\n<p>1、 <strong>短轮询 (Polling)</strong>:</p>\n<ul>\n<li><strong>原理</strong>：客户端以固定的时间间隔（例如每秒一次）频繁地向服务器发送请求，询问是否有新数据。</li>\n<li><strong>缺点</strong>：大量请求可能是无效的（无新数据），浪费服务器和带宽资源，实时性差。</li>\n</ul>\n<p><strong>短轮询 的流程图</strong></p>\n<p><img src=\"/post/SSE/7c3d97f93ae341888621ae5406c7a0c4-176312525096625.png\" alt=\"Image 15: Mermaid\"></p>\n<p>2、 <strong>长轮询 (Long Polling)</strong>:</p>\n<ul>\n<li><strong>原理</strong>：使用长连接请求数据。 客户端发送一个请求，服务器会保持这个连接打开（长连接），直到有新数据可用或超时。一旦客户端收到响应，会立即发起下一个请求。</li>\n<li><strong>缺点</strong>：虽然减少了无效请求，但每个连接仍然需要客户端发起，服务器需要维护大量挂起的连接，实现复杂。</li>\n</ul>\n<p><img src=\"/post/SSE/74bafe0add5e4d6ea786f8eb9cf95852-176312525096627.png\" alt=\"Image 16: Mermaid\"></p>\n<p>长轮询 (Long Polling) 突破：减少无效请求，但服务器需维护挂起连接</p>\n<p>3、 <strong>基于 Flash 的解决方案</strong>:</p>\n<ul>\n<li><strong>原理</strong>：利用 Adobe Flash 插件提供的 Socket 功能实现全双工通信。</li>\n<li><strong>缺点</strong>：依赖浏览器插件，在移动端（如 iPhone）不受支持，且随着技术的发展（Flash 被淘汰）已走向消亡。基于 Flash 方法都非原生支持，效率低下或依赖外部插件。</li>\n</ul>\n<p>4、 <strong>基于 WebSocket的解决方案</strong>:</p>\n<ul>\n<li><strong>原理</strong>：在客户端与服务器之间建立一条全双工的 TCP 长连接，双方可随时互相推送数据。</li>\n<li><strong>缺点</strong>： 需要一次额外的协议升级握手（<code>Upgrade: websocket</code>），对 CDN、防火墙、代理服务器的兼容性不如普通 HTTP； 双向通信能力在“服务器→客户端单向推送”场景下显得过度设计，增加心跳、重连、帧解析等复杂度；早期浏览器支持不一（IE ≤ 9 无原生实现），需要 Polyfill 或 Flash 降级方案。</li>\n</ul>\n<p><img src=\"/post/SSE/aa5e2f8ca644490399717a6c5134bf4d-176312525096629.png\" alt=\"Image 17: Mermaid\"></p>\n<p>WebSocket：全双工通道 革命性：摆脱HTTP束缚，实现真 实时交互</p>\n<p>WebSocket 并不是 Web 领域 的通讯协议，属于复杂度高 二进制通讯协议。</p>\n<h3 id=\"SSE-诞生的核心背景\"><a href=\"#SSE-诞生的核心背景\" class=\"headerlink\" title=\"SSE 诞生的核心背景\"></a>SSE 诞生的核心背景</h3><p>因此，Web 领域迫切需要一种<strong>标准化的、高效的、由浏览器原生支持的</strong>服务器到客户端的单向通信机制。这就是 SSE 诞生的核心背景。</p>\n<p><strong>核心需求：</strong></p>\n<ul>\n<li><strong>简单</strong>：易于服务器和客户端实现。</li>\n<li><strong>高效</strong>：基于 HTTP&#x2F;HTTPS，避免不必要的请求开销。</li>\n<li><strong>标准</strong>：成为 W3C 标准，得到浏览器原生支持。</li>\n<li><strong>自动重连</strong>：内置连接失败后自动重试的机制。</li>\n</ul>\n<p>SSE：真正的服务器推送</p>\n<p><img src=\"/post/SSE/1927caf78d734921afecee347ad56d9b-176312525096631.png\" alt=\"Image 18: Mermaid\"></p>\n<h2 id=\"1-3-SSE-发展历程\"><a href=\"#1-3-SSE-发展历程\" class=\"headerlink\" title=\"1.3 SSE 发展历程\"></a>1.3 SSE 发展历程</h2><p>SSE 的发展是 Web 标准化进程和实时通信需求共同推动的结果。</p>\n<p>下图概述了其关键发展节点：</p>\n<p><img src=\"/post/SSE/99c50040619043488243bd933358b5d1-176312525096633.png\" alt=\"Image 19: Mermaid\"></p>\n<p>让我们对图中的关键阶段进行详细解读：</p>\n<p><strong>1、 诞生背景（2006 年以前）</strong></p>\n<ul>\n<li>Web 早期只有“请求-响应”范式，实时需求（股票、IM、行情）只能靠轮询或长轮询，延迟高、浪费资源。</li>\n<li>Comet（长连接 iframe、jsonp、xhr-streaming 等 Hack 方案）出现，但实现复杂、浏览器兼容性差、占用连接数高。</li>\n<li>业界急需一种“浏览器原生、基于 HTTP、单向服务器推送”的轻量机制。</li>\n</ul>\n<p><strong>2、 概念提出与标准化 (约 2006-2009年)</strong></p>\n<ul>\n<li>SSE 的概念最初作为 <strong>HTML5</strong> 标准的一部分被提出，由 <strong>WHATWG</strong> (Web Hypertext Application Technology Working Group) 和 <strong>W3C</strong> (World Wide Web Consortium) 共同推动。</li>\n<li>其设计思想是定义一个简单的、基于 HTTP 的协议，允许服务器通过一个长连接持续地向客户端发送文本流。</li>\n<li>2006 年，Opera 9 在浏览器里率先实现名为 Server-Sent Events 的实验 API，用 DOM 事件把服务器推送的文本块喂给页面。</li>\n<li>同期 WHATWG HTML5 草案开始收录相关章节，定义了 text&#x2F;event-stream MIME 类型及“event: &#x2F; data:”行协议。</li>\n<li>后来，它从庞大的 HTML5 规范中分离出来，成为了一个独立的 W3C 标准文档。</li>\n<li>2008 年：SSE 被正式写入 HTML5 草案，随后进入 W3C 标准流程。</li>\n</ul>\n<p><strong>3、 浏览器支持与推广 (约 2010-2015年)</strong></p>\n<ul>\n<li><strong>2011年左右</strong>，主流浏览器（如 Firefox、Chrome、Safari、Opera）开始陆续支持 SSE API。 Firefox 6、Chrome 6、Safari 5、Opera 11.5 陆续完成原生实现；IE 系列缺席（直到 Edge 79 才补票）。</li>\n<li><strong>关键的障碍</strong>：<strong>Internet Explorer (包括 IE 11)</strong> 始终没有支持 SSE API。这在一定程度上限制了其早期的广泛应用，开发者通常需要为此准备降级方案（如回落到长轮询）。</li>\n<li>随着 Chrome、Firefox 等现代浏览器的市场份额不断上升，以及移动端浏览器对 SSE 的良好支持，SSE 逐渐成为开发实时 Web 应用的可信选择。</li>\n<li>2014 年 10 月：HTML5 成为 W3C Recommendation，SSE 作为官方子模块锁定最终语法，浏览器阵营格局定型。</li>\n</ul>\n<p><strong>4. 正式推荐与成熟 (2015年至2022 )</strong></p>\n<ul>\n<li><p>2015-2020 年，WebSocket 与 WebRTC 占据实时通信话题中心，SSE 主要在企业内部仪表盘、日志 tail 等低频场景默默使用。</p>\n</li>\n<li><p>SSE 由于有 “单向文本流 + 自动重连 + 轻量” 特性，<strong>所以没有被WebSocket 与 WebRTC 踩死</strong>， 使其在 IoT 设备、移动端 WebView 中仍保有一席之地。</p>\n</li>\n<li><p><strong>2015年</strong>，W3C 发布了 <strong>Server-Sent Events</strong> 的正式推荐标准，标志着该技术的成熟和稳定。</p>\n</li>\n<li><p>在此期间，前端生态框架（如 React、Vue.js）和后端语言（如 Node.js、Python、Java）都提供了对 SSE 的良好支持，出现了大量易用的库和示例。</p>\n</li>\n</ul>\n<p><strong>5、 大模型时代的爆发（2022 至今）</strong></p>\n<ul>\n<li><p>虽然 <strong>WebSocket</strong> 提供了全双工通信能力，但 SSE 因其简单的 API、基于 HTTP 带来的良好兼容性（如无需担心代理或防火墙问题）、以及自动重连等特性，在<strong>只需要服务器向客户端推送数据</strong>的场景中（如新闻推送、实时行情、状态更新、AI 处理进度流式输出等）成为了更简单、更合适的选择。</p>\n</li>\n<li><p>ChatGPT、Claude 等生成式 AI 需要“打字机”式逐 token 输出，SSE 天然契合：</p>\n</li>\n<li><p>基于 HTTP&#x2F;1.1 无需升级协议，CDN 缓存友好；</p>\n</li>\n<li><p>浏览器 EventSource API 一行代码即可接入；</p>\n</li>\n<li><p>文本流可直接承载 JSON Lines 或 markdown 片段。</p>\n</li>\n<li><p>2022 年底起，OpenAI、Anthropic、Google Bard 均把 text&#x2F;event-stream 作为官方流式回答协议，社区库（FastAPI SSE-Star、Spring WebFlux、Node sse.js、Go gin-sse）迎来二次繁荣。</p>\n</li>\n</ul>\n<h2 id=\"1-4、SSE-的主要特点\"><a href=\"#1-4、SSE-的主要特点\" class=\"headerlink\" title=\"1.4、SSE 的主要特点\"></a>1.4、SSE 的主要特点</h2><table>\n<thead>\n<tr>\n<th>特性</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>单向通信</strong></td>\n<td>仅支持服务器向客户端发送数据</td>\n</tr>\n<tr>\n<td><strong>基于 HTTP</strong></td>\n<td>无需升级协议或使用额外端口，兼容现有网络设施</td>\n</tr>\n<tr>\n<td><strong>自动重连</strong></td>\n<td>浏览器在连接断开后可自动重新建立连接</td>\n</tr>\n<tr>\n<td><strong>轻量易用</strong></td>\n<td>浏览器原生支持，API 简洁易懂</td>\n</tr>\n<tr>\n<td><strong>文本流支持</strong></td>\n<td>默认支持 UTF-8 文本，二进制数据需编码后传输</td>\n</tr>\n</tbody></table>\n<p>SSE和WebSocket 都能建立浏览器与服务器的长期通信，但区别很明显：</p>\n<ul>\n<li><strong>SSE</strong> 是单向推送 不是双向推送， 而且是http协议的一个扩展协议， 使用简单、自动重连，适合文本类实时推送。</li>\n<li><strong>WebSocket</strong> 是双向通信，不是 http协议的一个扩展协议，WebSocket 更灵活，但实现相对复杂。</li>\n</ul>\n<p><img src=\"/post/SSE/44e494b057564f0dbc977223c6824ec8-176312525096635.png\" alt=\"Image 20: image-20250828111134857\"></p>\n<p><strong>流程解读：</strong></p>\n<p>1、<strong>连接初始化</strong>：客户端使用特定的 <code>Content-Type: text/event-stream</code> 向服务器发起一个普通的 HTTP GET 请求。服务器确认并保持连接开放。</p>\n<p>2、<strong>数据推送</strong>：服务器通过保持打开的连接，以纯文本格式（遵循 <code>data: ...</code>、<code>event: ...</code> 等规范）持续发送数据块。每个消息以两个换行符 <code>\\n\\n</code> 结束。</p>\n<p>3、<strong>连接容错</strong>：如果连接因网络问题中断，SSE 客户端内置的机制会自动尝试重新建立连接，极大地提高了应用的鲁棒性。</p>\n<p>4、<strong>客户端处理</strong>：浏览器端的 <code>EventSource</code> API 会解析收到的数据流，触发相应的事件（如 <code>onmessage</code> 或自定义事件），让开发者能够处理推送来的数据</p>\n<p>SSE 的诞生是 Web 开发对<strong>简单、高效、标准化</strong>的服务器推送技术需求的直接结果。它有效地替代了笨拙的轮询技术，在与 WebSocket 的竞争中，找到了自身在<strong>单向数据流</strong>场景下的独特定位。</p>\n<p>其发展历程经历了从概念提出、浏览器支持到成为正式标准的完整路径。尽管曾受限于 IE，但在现代浏览器中已成为一项稳定、可靠且被广泛采用的技术。如今，在实时通知、金融仪表盘、实时日志跟踪和大型语言模型（LLM）的流式响应输出等场景中，SSE 都是首选的解决方案。</p>\n<h1 id=\"二：SSE-出来20年才一夜-爆火-，为什么？\"><a href=\"#二：SSE-出来20年才一夜-爆火-，为什么？\" class=\"headerlink\" title=\"二：SSE 出来20年才一夜 爆火 ，为什么？\"></a>二：SSE 出来20年才一夜 爆火 ，为什么？</h1><p><strong>SSE 最近站到聚光灯下，几乎可以说最大的推手就是当前 AI 应用（尤其是 ChatGPT 等大型语言模型）的爆发式增长。</strong></p>\n<p>SSE 之所以成为 AI 应用的“标配”，是因为 SSE 与 AI 所需的“打字机” 输出模式 是 <strong>天作之合</strong>。</p>\n<h2 id=\"2-1-什么是“打字机”-式逐-token-输出？\"><a href=\"#2-1-什么是“打字机”-式逐-token-输出？\" class=\"headerlink\" title=\"2.1 什么是“打字机” 式逐 token 输出？\"></a>2.1 什么是“打字机” 式逐 token 输出？</h2><p>“打字机”式 逐 token 输出是一种<strong>流式传输</strong>方式，它模拟了人类打字或思考的过程。</p>\n<p>服务器不是等待 LLM 生成整个答案 后一次性发送给 用户，而是 流式输出， <strong>每生成一个“词元”（token，可以粗略理解为一个词或一个字），就立刻发送这个“词元”</strong>。</p>\n<p>下面举一个例子，对比 一下 传统方式（非流式）和 “打字机” （流式）式 的过程。</p>\n<p><strong>传统方式（非流式）过程如下：</strong></p>\n<p>1、你提问：“请写一首关于春天的诗”。</p>\n<p>2、服务器端的 AI 开始思考、生成，整个过程你需要等待（可能好几秒甚至更久）。</p>\n<p>3、AI 生成完整的诗歌：“春风拂面绿意浓，百花争艳映晴空…”。</p>\n<p>4、服务器将<strong>整首诗</strong>作为一个完整的 JSON 对象 <code>{ &quot;content&quot;: &quot;春风拂面绿意浓，百花争艳映晴空...&quot; }</code> 发送给客户端。</p>\n<p>5、客户端一次性收到全部内容并渲染出来。</p>\n<p><strong>“打字机”（流式）过程如下：</strong></p>\n<p>1、你提问：“请写一首关于春天的诗”。</p>\n<p>2、服务器端的 AI 生成第一个 token “春”，<strong>立刻</strong>通过 SSE 发送 <code>data: “春”</code>。</p>\n<p>3、客户端收到“春”并显示出来。</p>\n<p>4、AI 生成第二个 token “风”，<strong>立刻</strong>发送 <code>data: “风”</code>。</p>\n<p>5、客户端在“春”后面追加“风”，形成“春风”。</p>\n<p>6、后续 token “拂”、“面”、“绿”、“意”、“浓”… 依次迅速发送和追加。</p>\n<p>7、你看到的效果就是<strong>文字一个接一个地“打”在屏幕上</strong>，就像有人在远端为你实时打字一样。</p>\n<p><strong>“打字机”（流式） 模式的巨大优势：</strong></p>\n<p>1、<strong>极低的感知延迟</strong>：用户几乎在提问后瞬间就能看到第一个字开始输出，无需经历漫长的等待白屏期，体验流畅自然。</p>\n<p>2、<strong>提供了“正在进行”的反馈</strong>：看着文字逐个出现，给人一种模型正在为你“思考”和“创作”的生动感，而不是在“沉默中宕机”。</p>\n<p>3、<strong>更高效地利用时间</strong>：用户可以在前半句还在输出时，就开始阅读和理解，节省了总体的认知时间。</p>\n<h2 id=\"2-2-为什么-SSE-是这种模式的“天作之合”？\"><a href=\"#2-2-为什么-SSE-是这种模式的“天作之合”？\" class=\"headerlink\" title=\"2.2 为什么 SSE 是这种模式的“天作之合”？\"></a>2.2 为什么 SSE 是这种模式的“天作之合”？</h2><p>这正是 SSE 的设计初衷和核心优势所在，它与 AI 流式输出的需求完美匹配：</p>\n<p>1、<strong>单向通信的完美匹配</strong>：</p>\n<p>AI 的文本生成过程本质上是<strong>服务器到客户端的单向数据推送</strong>。</p>\n<p>客户端只需要接收，不需要在生成过程中频繁地发送请求。</p>\n<p>SSE 的“服务器推送”模型正是为此而生，而 WebSocket 的双向能力在这里是多余的。</p>\n<p>2、<strong>基于 HTTP&#x2F;HTTPS，简单且兼容</strong>：</p>\n<p>SSE 使用标准的 HTTP 协议，这意味着 <strong>SSE 易于实现和调试</strong>：任何后端框架和前端语言都能轻松处理。在浏览器中调试时，你可以在“网络”选项卡中直接看到以文本流形式传输的事件，非常直观。</p>\n<p>SSE 使用标准的 HTTP 协议，这还意味着 <strong>容易绕过网络障碍</strong>：公司防火墙和代理通常对 HTTP&#x2F;HTTPS 放行，而可能会阻拦陌生的 WebSocket 协议。这使得 SSE 的部署兼容性极好。</p>\n<p>3、<strong>内置的自动重连机制</strong>：</p>\n<p>网络连接并不完全可靠。</p>\n<p>如果用户在接收很长的回答时网络波动，连接中断，SSE 客户端会自动尝试重新连接。</p>\n<p>这对于长时间流的应用至关重要，提供了天然的鲁棒性。</p>\n<p>4、<strong>轻量级的文本协议</strong>：</p>\n<p>AI 流式输出传输的就是文本（UTF-8编码）。SSE 的协议 <code>data: ...\\n\\n</code> 就是为传输文本片段而设计的，极其高效和简单。</p>\n<p>WebSocket 虽然也能传文本，但其协议设计还考虑了二进制帧、掩码等更复杂的情况，对于纯文本流来说显得有些“重”。</p>\n<p>5、<strong>原生浏览器 API</strong>：</p>\n<p>现代浏览器都原生支持 <code>EventSource</code> API，开发者无需引入额外的第三方库，即可轻松实现接收流式数据，减少了依赖和打包体积。</p>\n<p><img src=\"/post/SSE/2c656cc828824defb2d90014ee478c52-176312525096637.png\" alt=\"Image 21: Mermaid\"></p>\n<p>所以，<strong>SSE 站到聚光灯下的原因正是：</strong></p>\n<p><strong>AI 应用需要“打字机”式的逐 token 输出体验，而 SSE 作为一种基于 HTTP 的、简单的、单向的服务器推送技术，是实现这种体验最自然、最高效、最可靠的技术选择。</strong></p>\n<p>它就像是为这个场景量身定做的工具，没有多余的功能，只有恰到好处的设计。</p>\n<p>因此，当 ChatGPT 等应用席卷全球时，其背后默默无闻的 SSE 技术也终于从幕后走到了台前，被广大开发者所重新认识和重视。</p>\n<h1 id=\"三、SSE-的工作原理\"><a href=\"#三、SSE-的工作原理\" class=\"headerlink\" title=\"三、SSE 的工作原理\"></a>三、SSE 的工作原理</h1><h2 id=\"3-1-工作机制的流程图\"><a href=\"#3-1-工作机制的流程图\" class=\"headerlink\" title=\"3.1 工作机制的流程图\"></a>3.1 工作机制的流程图</h2><p>SSE 通过一个持久的 HTTP 连接实现服务器到客户端的单向数据流。</p>\n<p><strong>关键步骤解析：</strong></p>\n<p><strong>1、浏览器发起一个 HTTP 请求，Header 中包含：</strong></p>\n<figure class=\"highlight vbnet\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">Accept:</span> <span class=\"keyword\">text</span>/<span class=\"keyword\">event</span>-stream</span><br></pre></td></tr></table></figure>\n\n<p><strong>2、服务器响应类型必须为：</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">Content-Type:</span> <span class=\"string\">text/event-stream</span></span><br><span class=\"line\"><span class=\"attr\">Cache-Control:</span> <span class=\"literal\">no</span><span class=\"string\">-cache</span></span><br><span class=\"line\"><span class=\"attr\">Connection:</span> <span class=\"string\">keep-alive</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>3、服务器发送事件格式（每个事件以两个换行符结束）：</strong></p>\n<figure class=\"highlight avrasm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">event:</span> message</span><br><span class=\"line\"><span class=\"symbol\">data:</span> &#123;<span class=\"string\">&quot;time&quot;</span>: <span class=\"string\">&quot;2023-10-05T12:00:00&quot;</span>, <span class=\"string\">&quot;value&quot;</span>: <span class=\"string\">&quot;New update!&quot;</span>&#125;</span><br><span class=\"line\"><span class=\"symbol\">id:</span> <span class=\"number\">12345</span></span><br><span class=\"line\"><span class=\"symbol\">retry:</span> <span class=\"number\">5000</span></span><br><span class=\"line\">\\n\\n</span><br></pre></td></tr></table></figure>\n\n<p><strong>4、浏览器通过 <code>EventSource</code>API 接收并处理事件。</strong></p>\n<p><strong>5、服务器发送 一个特殊“结束”事件，可以结束传输。</strong></p>\n<p>比如，服务器发送一个如 <code>event: end</code> 的消息，可以结束传输。</p>\n<p>客户端预先监听这个自定义的 <code>end</code> 事件，一旦收到，就知道传输结束，并可以<strong>选择主动关闭 EventSource 连接</strong>。</p>\n<p><strong>6、若连接中断，浏览器会根据 <code>retry</code>字段自动重连。</strong></p>\n<p>如果没有收到 特殊“结束”事件， 浏览器 可以自动重连。</p>\n<h2 id=\"3-2、SSE-与其他通信方式对比\"><a href=\"#3-2、SSE-与其他通信方式对比\" class=\"headerlink\" title=\"3.2、SSE 与其他通信方式对比\"></a>3.2、SSE 与其他通信方式对比</h2><p>不同通信技术各有适用场景，我们用表格清晰对比：</p>\n<table>\n<thead>\n<tr>\n<th>技术</th>\n<th>通信方向</th>\n<th>基于协议</th>\n<th>复杂度</th>\n<th>适用场景</th>\n<th>浏览器原生支持</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>轮询（Polling）</td>\n<td>客户端→服务器</td>\n<td>HTTP</td>\n<td>简单</td>\n<td>数据更新频率低（如定时查邮件）</td>\n<td>全部</td>\n</tr>\n<tr>\n<td>长轮询（Long Polling）</td>\n<td>客户端→服务器</td>\n<td>HTTP</td>\n<td>中等</td>\n<td>低频但需实时（如即时消息提醒）</td>\n<td>全部</td>\n</tr>\n<tr>\n<td>SSE</td>\n<td>服务器→客户端</td>\n<td>HTTP</td>\n<td>简单</td>\n<td>持续单向推送（如实时日志、股价、chartGPT）</td>\n<td>（除IE）</td>\n</tr>\n<tr>\n<td>WebSocket</td>\n<td>双向</td>\n<td>自定义协议</td>\n<td>复杂</td>\n<td>互动性强（如在线游戏、视频聊天）</td>\n<td>全部</td>\n</tr>\n</tbody></table>\n<p>简单说：</p>\n<ul>\n<li>只需服务器”说话”选SSE</li>\n<li>需要双方”对话”选WebSocket</li>\n<li>偶尔查一次数据选轮询&#x2F;长轮询</li>\n</ul>\n<h2 id=\"3-3-SSE-的适用场景\"><a href=\"#3-3-SSE-的适用场景\" class=\"headerlink\" title=\"3.3 SSE 的适用场景\"></a>3.3 SSE 的适用场景</h2><p><strong>1、ChatGPT 式逐字输出( “打字机” 式逐 词元 token输出)</strong></p>\n<p><img src=\"/post/SSE/ac3887ce3546479a8ff1fe5a7027643f-176312525096639.png\" alt=\"Image 23: image-20250828131743395\"></p>\n<p><strong>2、实时通知系统</strong></p>\n<ul>\n<li>新订单提醒</li>\n<li>用户消息推送</li>\n<li>审核状态更新</li>\n</ul>\n<p><strong>3、实时数据看板</strong></p>\n<ul>\n<li>股票行情</li>\n<li>设备监控数据</li>\n<li>实时日志流</li>\n</ul>\n<h1 id=\"四、sse-客户端-API-详解\"><a href=\"#四、sse-客户端-API-详解\" class=\"headerlink\" title=\"四、sse 客户端 API 详解\"></a>四、sse 客户端 API 详解</h1><p>SSE的客户端实现非常简单，浏览器原生提供了<code>EventSource</code>对象来处理与服务器的SSE连接。下面我们详细介绍它的使用方法和核心特性。</p>\n<h2 id=\"4-1、认识-浏览器-EventSource对象\"><a href=\"#4-1、认识-浏览器-EventSource对象\" class=\"headerlink\" title=\"4.1、认识 浏览器 EventSource对象\"></a>4.1、认识 浏览器 EventSource对象</h2><h3 id=\"浏览器兼容性检测\"><a href=\"#浏览器兼容性检测\" class=\"headerlink\" title=\"浏览器兼容性检测\"></a>浏览器兼容性检测</h3><p>在使用SSE前，首先需要确认当前浏览器是否支持<code>EventSource</code>（除IE&#x2F;Edge外，几乎所有现代浏览器都支持）。检测方法如下：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 检查浏览器是否支持SSE</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"string\">&#x27;EventSource&#x27;</span> <span class=\"keyword\">in</span> <span class=\"variable language_\">window</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 支持SSE，可正常使用</span></span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;浏览器支持SSE&#x27;</span>);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 不支持SSE，需降级处理</span></span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;浏览器不支持SSE&#x27;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建连接\"><a href=\"#创建连接\" class=\"headerlink\" title=\"创建连接\"></a>创建连接</h3><p>使用<code>EventSource</code>创建与服务器的连接非常简单，只需传入服务器的SSE接口地址：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 建立与服务器的SSE连接</span></span><br><span class=\"line\"><span class=\"comment\">// url为服务器提供的SSE接口地址（可同域或跨域）</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> source = <span class=\"keyword\">new</span> <span class=\"title class_\">EventSource</span>(url);</span><br></pre></td></tr></table></figure>\n\n<p>如果需要跨域请求并携带Cookie，可通过第二个参数配置：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 跨域请求时，允许携带Cookie</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> source = <span class=\"keyword\">new</span> <span class=\"title class_\">EventSource</span>(url, &#123; </span><br><span class=\"line\">  <span class=\"attr\">withCredentials</span>: <span class=\"literal\">true</span>  <span class=\"comment\">// 默认为false，设为true表示跨域请求携带Cookie</span></span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"连接状态（readyState）\"><a href=\"#连接状态（readyState）\" class=\"headerlink\" title=\"连接状态（readyState）\"></a>连接状态（readyState）</h3><p><code>EventSource</code>实例的<code>readyState</code>属性用于表示当前连接状态，只读且有三个可能值：</p>\n<table>\n<thead>\n<tr>\n<th>值</th>\n<th>常量对应</th>\n<th>含义说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0</td>\n<td>EventSource.CONNECTING</td>\n<td>连接未建立，或断线后正在重连</td>\n</tr>\n<tr>\n<td>1</td>\n<td>EventSource.OPEN</td>\n<td>连接已建立，可正常接收服务器推送的数据</td>\n</tr>\n<tr>\n<td>2</td>\n<td>EventSource.CLOSED</td>\n<td>连接已关闭，且不会自动重连</td>\n</tr>\n</tbody></table>\n<p>可以通过该属性判断当前连接状态，例如：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (source.<span class=\"property\">readyState</span> === <span class=\"title class_\">EventSource</span>.<span class=\"property\">OPEN</span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;SSE连接已正常建立&#x27;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-2、基本使用方法\"><a href=\"#4-2、基本使用方法\" class=\"headerlink\" title=\"4.2、基本使用方法\"></a>4.2、基本使用方法</h2><p><code>EventSource</code>通过事件机制处理连接过程中的各种状态和接收的数据，核心事件包括<code>open</code>、<code>message</code>、<code>error</code>。</p>\n<p>下面用流程图展示SSE客户端的完整使用流程：</p>\n<p><img src=\"/post/SSE/292bd236fc4042b3aff73c6a19f1b16e-176312525096641.png\" alt=\"Image 24: Mermaid\"></p>\n<h3 id=\"连接建立：open事件\"><a href=\"#连接建立：open事件\" class=\"headerlink\" title=\"连接建立：open事件\"></a>连接建立：open事件</h3><p>当客户端与服务器成功建立SSE连接时，会触发<code>open</code>事件：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 方式1：使用onopen属性</span></span><br><span class=\"line\">source.<span class=\"property\">onopen</span> = <span class=\"keyword\">function</span> (<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;SSE连接已建立&#x27;</span>);</span><br><span class=\"line\">  <span class=\"comment\">// 可在此处做连接成功后的初始化操作，如更新UI状态</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 方式2：使用addEventListener（推荐，可添加多个回调）</span></span><br><span class=\"line\">source.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;open&#x27;</span>, <span class=\"keyword\">function</span> (<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;SSE连接已建立（监听方式）&#x27;</span>);</span><br><span class=\"line\">&#125;, <span class=\"literal\">false</span>);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"接收数据：message事件\"><a href=\"#接收数据：message事件\" class=\"headerlink\" title=\"接收数据：message事件\"></a>接收数据：message事件</h3><p>当客户端收到服务器推送的数据时，会触发<code>message</code>事件（默认事件，处理未指定类型的消息）：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 方式1：使用onmessage属性</span></span><br><span class=\"line\">source.<span class=\"property\">onmessage</span> = <span class=\"keyword\">function</span> (<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// event.data为服务器推送的文本数据</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> data = event.<span class=\"property\">data</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;收到数据：&#x27;</span>, data);</span><br><span class=\"line\">  <span class=\"comment\">// 可在此处处理数据，如更新页面内容</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 方式2：使用addEventListener</span></span><br><span class=\"line\">source.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;message&#x27;</span>, <span class=\"keyword\">function</span> (<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> data = event.<span class=\"property\">data</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;收到数据（监听方式）：&#x27;</span>, data);</span><br><span class=\"line\">&#125;, <span class=\"literal\">false</span>);</span><br></pre></td></tr></table></figure>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注意：<code>event.data</code>始终是字符串类型，如果服务器发送的是JSON数据，需要用<code>JSON.parse(data)</code>转换。</p></blockquote>\n<h3 id=\"连接错误：error事件\"><a href=\"#连接错误：error事件\" class=\"headerlink\" title=\"连接错误：error事件\"></a>连接错误：error事件</h3><p>当连接发生错误（如网络中断、服务器出错）时，会触发<code>error</code>事件：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 方式1：使用onerror属性</span></span><br><span class=\"line\">source.<span class=\"property\">onerror</span> = <span class=\"keyword\">function</span> (<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 可根据readyState判断错误类型</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (source.<span class=\"property\">readyState</span> === <span class=\"title class_\">EventSource</span>.<span class=\"property\">CONNECTING</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;连接出错，正在尝试重连...&#x27;</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;连接已关闭，无法重连&#x27;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 方式2：使用addEventListener</span></span><br><span class=\"line\">source.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;error&#x27;</span>, <span class=\"keyword\">function</span> (<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 错误处理逻辑</span></span><br><span class=\"line\">&#125;, <span class=\"literal\">false</span>);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"关闭连接：close-方法\"><a href=\"#关闭连接：close-方法\" class=\"headerlink\" title=\"关闭连接：close()方法\"></a>关闭连接：close()方法</h3><p>如果需要主动关闭SSE连接（关闭后不会自动重连），可调用<code>close()</code>方法：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 主动关闭SSE连接</span></span><br><span class=\"line\">source.<span class=\"title function_\">close</span>();</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;SSE连接已手动关闭&#x27;</span>);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-3、自定义事件\"><a href=\"#4-3、自定义事件\" class=\"headerlink\" title=\"4.3、自定义事件\"></a>4.3、自定义事件</h2><p>默认情况下，服务器推送的消息会触发<code>message</code>事件。</p>\n<p>但实际开发中，我们可能需要区分不同类型的消息（如”新订单通知”和”系统公告”），这时就可以使用<strong>自定义事件</strong>。</p>\n<p>客户端通过<code>addEventListener</code>监听自定义事件名，例如监听<code>order</code>事件：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 监听名为&quot;order&quot;的自定义事件</span></span><br><span class=\"line\">source.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;order&#x27;</span>, <span class=\"keyword\">function</span> (<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> orderData = event.<span class=\"property\">data</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;收到新订单：&#x27;</span>, orderData);</span><br><span class=\"line\">  <span class=\"comment\">// 处理订单相关逻辑</span></span><br><span class=\"line\">&#125;, <span class=\"literal\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 再监听一个名为&quot;notice&quot;的自定义事件</span></span><br><span class=\"line\">source.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;notice&#x27;</span>, <span class=\"keyword\">function</span> (<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> noticeData = event.<span class=\"property\">data</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;收到系统公告：&#x27;</span>, noticeData);</span><br><span class=\"line\">  <span class=\"comment\">// 处理公告相关逻辑</span></span><br><span class=\"line\">&#125;, <span class=\"literal\">false</span>);</span><br></pre></td></tr></table></figure>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注意：自定义事件不会触发<code>message</code>事件，只会被对应的<code>addEventListener</code>捕获。</p>\n<p>上面代码中，浏览器对 SSE 的<code>foo``notice</code>事件进行监听。如何实现服务器发送<code>foo``notice</code>事件，请看下文。</p></blockquote>\n<h1 id=\"五、SSE服务器实现：数据格式与规则\"><a href=\"#五、SSE服务器实现：数据格式与规则\" class=\"headerlink\" title=\"五、SSE服务器实现：数据格式与规则\"></a>五、SSE服务器实现：数据格式与规则</h1><p>服务器要实现SSE，核心是按照特定格式向客户端发送数据。</p>\n<p>下面详细介绍服务器端的实现规范。</p>\n<h2 id=\"5-1-HTTP-头信息要求\"><a href=\"#5-1-HTTP-头信息要求\" class=\"headerlink\" title=\"5.1 HTTP 头信息要求\"></a>5.1 HTTP 头信息要求</h2><p>服务器向客户端发送SSE数据时，必须设置以下HTTP响应头，否则客户端无法正确识别为事件流：</p>\n<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Content-Type</span><span class=\"punctuation\">: </span>text/event-stream  // 必须，指定为事件流类型</span><br><span class=\"line\"><span class=\"attribute\">Cache-Control</span><span class=\"punctuation\">: </span>no-cache          // 必须，禁止缓存，确保数据实时性</span><br><span class=\"line\"><span class=\"attribute\">Connection</span><span class=\"punctuation\">: </span>keep-alive           // 必须，保持长连接</span><br></pre></td></tr></table></figure>\n\n<p>这三个头信息是SSE的基础，缺少任何一个都可能导致连接失败或数据异常。</p>\n<h2 id=\"5-2-数据传输格式\"><a href=\"#5-2-数据传输格式\" class=\"headerlink\" title=\"5.2 数据传输格式\"></a>5.2 数据传输格式</h2><p>服务器发送的每条消息（message）由多行组成，每行格式为<code>[字段]: 值\\n</code>（字段名后必须跟冒号和空格，结尾用换行符<code>\\n</code>）。</p>\n<p>多条消息之间用<code>\\n\\n</code>（两个换行符）分隔。</p>\n<p>此外，以<code>:</code>开头的行是注释（服务器可定期发送注释保持连接）。</p>\n<p><strong>基本格式示例</strong></p>\n<figure class=\"highlight haskell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">: 这是一条注释（客户端会忽略）\\n</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">data</span>: 这是第一条消息\\n\\n</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">data</span>: 这是第二条消息的第一行\\n</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">data</span>: 这是第二条消息的第二行\\n\\n</span></span><br></pre></td></tr></table></figure>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注意：换行符必须是<code>\\n</code>（Unix格式），<code>\\r\\n</code>可能导致客户端解析错误。</p></blockquote>\n<h2 id=\"5-3-核心字段说明\"><a href=\"#5-3-核心字段说明\" class=\"headerlink\" title=\"5.3 核心字段说明\"></a>5.3 核心字段说明</h2><p>SSE消息支持四个核心字段，分别用于不同场景：</p>\n<h3 id=\"1-data字段：消息内容\"><a href=\"#1-data字段：消息内容\" class=\"headerlink\" title=\"1. data字段：消息内容\"></a>1. data字段：消息内容</h3><p><code>data</code>字段用于携带实际的消息内容，是最常用的字段。</p>\n<ul>\n<li>单行数据：</li>\n</ul>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">data</span>: Hello, SSE!\\n\\n  <span class=\"comment\">// 单行数据，以\\n\\n结束</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>多行数据（适合JSON等复杂结构）：</li>\n</ul>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">data</span>: &#123;\\n               <span class=\"comment\">// 第一行以\\n结束</span></span><br><span class=\"line\"><span class=\"keyword\">data</span>: <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;张三&quot;</span>,\\n  <span class=\"comment\">// 第二行以\\n结束</span></span><br><span class=\"line\"><span class=\"keyword\">data</span>: <span class=\"string\">&quot;age&quot;</span>: <span class=\"number\">20</span>\\n        <span class=\"comment\">// 第三行以\\n结束</span></span><br><span class=\"line\"><span class=\"keyword\">data</span>: &#125;\\n\\n              <span class=\"comment\">// 最后一行以\\n\\n结束</span></span><br></pre></td></tr></table></figure>\n\n<p>客户端接收后，<code>event.data</code>会自动拼接为完整字符串：<code>{&quot;name&quot;: &quot;张三&quot;,&quot;age&quot;: 20}</code></p>\n<h3 id=\"2-event字段：指定事件类型\"><a href=\"#2-event字段：指定事件类型\" class=\"headerlink\" title=\"2. event字段：指定事件类型\"></a>2. event字段：指定事件类型</h3><p><code>event</code>字段用于指定消息的事件类型，客户端可通过对应事件名监听（即3.3节的自定义事件）。</p>\n<p>服务器发送：</p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">event</span>: order\\n           <span class=\"comment\">// 指定事件类型为order</span></span><br><span class=\"line\">data: 新订单ID：<span class=\"number\">12345</span>\\n   <span class=\"comment\">// 消息内容</span></span><br><span class=\"line\">\\n                       <span class=\"comment\">// 消息结束（\\n\\n简化为单独一行）</span></span><br></pre></td></tr></table></figure>\n\n<p>客户端监听：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&#x27;order&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(event.<span class=\"property\">data</span>);  <span class=\"comment\">// 输出：新订单ID：12345</span></span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-id字段：消息标识\"><a href=\"#3-id字段：消息标识\" class=\"headerlink\" title=\"3. id字段：消息标识\"></a>3. id字段：消息标识</h3><p><code>id</code>字段用于给消息设置唯一标识，客户端会自动记录最后一条消息的<code>id</code>（存于<code>source.lastEventId</code>）。</p>\n<p><strong>核心作用</strong>：当连接断线重连时，客户端会在请求头中携带<code>Last-Event-ID: [最后收到的id]</code>，服务器可根据该ID恢复数据传输（避免重复或丢失）。</p>\n<p>服务器发送：</p>\n<figure class=\"highlight kotlin\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">id: msg1001\\n            <span class=\"comment\">// 消息标识</span></span><br><span class=\"line\"><span class=\"keyword\">data</span>: 这是第<span class=\"number\">1001</span>条消息\\n</span><br><span class=\"line\">\\n</span><br></pre></td></tr></table></figure>\n\n<p>客户端重连时的请求头：</p>\n<figure class=\"highlight http\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Last-Event-ID</span><span class=\"punctuation\">: </span>msg1001  // 自动携带最后收到的id</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4-retry字段：重连间隔\"><a href=\"#4-retry字段：重连间隔\" class=\"headerlink\" title=\"4. retry字段：重连间隔\"></a>4. retry字段：重连间隔</h3><p><code>retry</code>字段用于指定客户端断线后的重连间隔（单位：毫秒），默认重连间隔约为3秒。</p>\n<p>服务器发送：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">retry:</span> <span class=\"number\">5000</span><span class=\"string\">\\n</span>            <span class=\"string\">//</span> <span class=\"string\">告诉客户端，断线后5秒再重连</span></span><br><span class=\"line\"><span class=\"attr\">data:</span> <span class=\"string\">重连间隔已设置为5秒\\n</span></span><br><span class=\"line\"><span class=\"string\">\\n</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5-服务器保持连接示例\"><a href=\"#5-服务器保持连接示例\" class=\"headerlink\" title=\"5. 服务器保持连接示例\"></a>5. 服务器保持连接示例</h3><p>服务器可以定期发送注释行，保持连接活跃：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">:</span> <span class=\"string\">这是保持连接活动的注释行\\n</span></span><br><span class=\"line\"><span class=\"string\">:</span> <span class=\"string\">服务器时间</span> <span class=\"number\">2023-10-05T12:00:00</span><span class=\"string\">\\n</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-4-服务器发送流程\"><a href=\"#5-4-服务器发送流程\" class=\"headerlink\" title=\"5.4 服务器发送流程\"></a>5.4 服务器发送流程</h2><p>服务器发送SSE数据的完整流程如下：</p>\n<p><img src=\"/post/SSE/daace7683c264776b2c227eb0dcd85d9-176312525096643.png\" alt=\"Image 25: Mermaid\"></p>\n<p>下面是一个包含多种字段的服务器发送示例，模拟一个实时通知系统：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">:</span> <span class=\"string\">服务器开始发送消息（注释）\\n</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">id:</span> <span class=\"number\">1001</span><span class=\"string\">\\n</span></span><br><span class=\"line\"><span class=\"attr\">event:</span> <span class=\"string\">notice\\n</span></span><br><span class=\"line\"><span class=\"attr\">data:</span> <span class=\"string\">系统将在10分钟后维护\\n\\n</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">id:</span> <span class=\"number\">1002</span><span class=\"string\">\\n</span></span><br><span class=\"line\"><span class=\"attr\">event:</span> <span class=\"string\">order\\n</span></span><br><span class=\"line\"><span class=\"attr\">data:</span> &#123;<span class=\"attr\">&quot;orderId&quot;:</span> <span class=\"string\">&quot;20230501&quot;</span>, <span class=\"attr\">&quot;status&quot;:</span> <span class=\"string\">&quot;paid&quot;</span>&#125;<span class=\"string\">\\n\\n</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">retry:</span> <span class=\"number\">10000</span><span class=\"string\">\\n</span></span><br><span class=\"line\"><span class=\"attr\">id:</span> <span class=\"number\">1003</span><span class=\"string\">\\n</span></span><br><span class=\"line\"><span class=\"attr\">data:</span> <span class=\"string\">重连间隔已调整为10秒\\n\\n</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">:</span> <span class=\"string\">这是保持连接活动的注释行\\n</span></span><br><span class=\"line\"><span class=\"string\">:</span> <span class=\"string\">服务器时间</span> <span class=\"number\">2023-10-05T12:00:00</span><span class=\"string\">\\n</span></span><br></pre></td></tr></table></figure>\n\n<p>客户端接收后：</p>\n<ul>\n<li><code>notice</code>事件会捕获到”系统将在10分钟后维护”</li>\n<li><code>order</code>事件会捕获到订单JSON数据</li>\n<li>重连间隔被设置为10秒</li>\n<li>最后收到的消息ID是1003（断线重连时会携带）</li>\n</ul>\n<p>通过以上规范，服务器就能轻松实现SSE功能，向客户端实时推送数据。</p>\n<p>相比WebSocket，SSE的服务器实现更简单，无需处理复杂的协议握手，只需按格式发送文本数据即可。</p>\n<h1 id=\"六、SSE最佳实践\"><a href=\"#六、SSE最佳实践\" class=\"headerlink\" title=\"六、SSE最佳实践\"></a>六、SSE最佳实践</h1><h2 id=\"6-1-前端\"><a href=\"#6-1-前端\" class=\"headerlink\" title=\"6.1 前端\"></a>6.1 前端</h2><p>前端采用vue3.2语法格式</p>\n<p>在api下新建index.js</p>\n<p><img src=\"/post/SSE/image-20251114214359869.png\" alt=\"image-20251114214359869\"></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> axios <span class=\"keyword\">from</span> <span class=\"string\">&#x27;axios&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 根据环境变量设置 API 基础 URL</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">API_BASE_URL</span> = process.<span class=\"property\">env</span>.<span class=\"property\">NODE_ENV</span> === <span class=\"string\">&#x27;production&#x27;</span> </span><br><span class=\"line\"> ? <span class=\"string\">&#x27;/api&#x27;</span> <span class=\"comment\">// 生产环境使用相对路径，适用于前后端部署在同一域名下</span></span><br><span class=\"line\"> : <span class=\"string\">&#x27;http://localhost:12345&#x27;</span> <span class=\"comment\">// 开发环境指向本地后端服务</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 创建axios实例</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> request = axios.<span class=\"title function_\">create</span>(&#123;</span><br><span class=\"line\">  <span class=\"attr\">baseURL</span>: <span class=\"variable constant_\">API_BASE_URL</span>,</span><br><span class=\"line\">  <span class=\"attr\">timeout</span>: <span class=\"number\">60000</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 封装SSE连接</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> <span class=\"title function_\">connectSSE</span> = (<span class=\"params\">url, params, onMessage, onError</span>) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 构建带参数的URL</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> queryString = <span class=\"title class_\">Object</span>.<span class=\"title function_\">keys</span>(params || &#123;&#125;)</span><br><span class=\"line\">    .<span class=\"title function_\">map</span>(<span class=\"function\"><span class=\"params\">key</span> =&gt;</span> <span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"built_in\">encodeURIComponent</span>(key)&#125;</span>=<span class=\"subst\">$&#123;<span class=\"built_in\">encodeURIComponent</span>(params[key])&#125;</span>`</span>)</span><br><span class=\"line\">    .<span class=\"title function_\">join</span>(<span class=\"string\">&#x27;&amp;&#x27;</span>)</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">const</span> fullUrl = <span class=\"string\">`<span class=\"subst\">$&#123;API_BASE_URL&#125;</span><span class=\"subst\">$&#123;url&#125;</span><span class=\"subst\">$&#123;queryString ? <span class=\"string\">`?<span class=\"subst\">$&#123;queryString&#125;</span>`</span> : <span class=\"string\">&#x27;&#x27;</span>&#125;</span>`</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// 创建EventSource</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> eventSource = <span class=\"keyword\">new</span> <span class=\"title class_\">EventSource</span>(fullUrl)</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// 监听消息</span></span><br><span class=\"line\">  eventSource.<span class=\"property\">onmessage</span> = <span class=\"function\"><span class=\"params\">event</span> =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> data = event.<span class=\"property\">data</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 检查是否是特殊标记</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (data === <span class=\"string\">&#x27;done&#x27;</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (onMessage) <span class=\"title function_\">onMessage</span>(<span class=\"string\">&#x27;done&#x27;</span>)</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 处理普通消息</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (onMessage) <span class=\"title function_\">onMessage</span>(data)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// 监听错误</span></span><br><span class=\"line\">  eventSource.<span class=\"property\">onerror</span> = <span class=\"function\">(<span class=\"params\">error</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 如果已经被我们主动关闭，直接忽略</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (eventSource.<span class=\"property\">readyState</span> === <span class=\"title class_\">EventSource</span>.<span class=\"property\">CLOSED</span>) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">error</span>(<span class=\"string\">&#x27;SSE Error:&#x27;</span>, error)</span><br><span class=\"line\">    onError &amp;&amp; <span class=\"title function_\">onError</span>(error);</span><br><span class=\"line\">    eventSource.<span class=\"title function_\">close</span>();</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// 返回eventSource实例，以便后续可以关闭连接</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> eventSource</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> <span class=\"title function_\">getFluxData</span> = (<span class=\"params\">message, chatId</span>) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"title function_\">connectSSE</span>(<span class=\"string\">&#x27;/sse/chat/emitter&#x27;</span>, &#123; message, chatId &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span><br><span class=\"line\">  getFluxData</span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n\n<p>聊天室组件</p>\n<p><img src=\"/post/SSE/image-20251114214321557.png\" alt=\"image-20251114214321557\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">  &lt;div class=&quot;chat-container&quot;&gt;</span><br><span class=\"line\">    &lt;!-- 聊天记录区域 --&gt;</span><br><span class=\"line\">    &lt;div class=&quot;chat-messages&quot; ref=&quot;messagesContainer&quot;&gt;</span><br><span class=\"line\">      &lt;div v-for=&quot;(msg, index) in messages&quot; :key=&quot;index&quot; class=&quot;message-wrapper&quot;&gt;</span><br><span class=\"line\">        &lt;!-- AI消息 --&gt;</span><br><span class=\"line\">        &lt;div v-if=&quot;!msg.isUser&quot; class=&quot;message ai-message&quot; :class=&quot;[msg.type]&quot;&gt;</span><br><span class=\"line\">          &lt;div class=&quot;avatar ai-avatar&quot;&gt;</span><br><span class=\"line\">            &lt;div class=&quot;ai-avatar-fallback&quot;&gt;</span><br><span class=\"line\">              &lt;span&gt;🤖&lt;/span&gt;</span><br><span class=\"line\">            &lt;/div&gt;</span><br><span class=\"line\">          &lt;/div&gt;</span><br><span class=\"line\">          &lt;div class=&quot;message-bubble&quot;&gt;</span><br><span class=\"line\">            &lt;div class=&quot;message-content&quot;&gt;</span><br><span class=\"line\">              &#123;&#123; msg.content &#125;&#125;</span><br><span class=\"line\">              &lt;span v-if=&quot;connectionStatus === &#x27;connecting&#x27; &amp;&amp; index === messages.length - 1&quot;</span><br><span class=\"line\">                class=&quot;typing-indicator&quot;&gt;▋&lt;/span&gt;</span><br><span class=\"line\">            &lt;/div&gt;</span><br><span class=\"line\">            &lt;div class=&quot;message-time&quot;&gt;&#123;&#123; formatTime(msg.time) &#125;&#125;&lt;/div&gt;</span><br><span class=\"line\">          &lt;/div&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">        &lt;!-- 用户消息 --&gt;</span><br><span class=\"line\">        &lt;div v-else class=&quot;message user-message&quot; :class=&quot;[msg.type]&quot;&gt;</span><br><span class=\"line\">          &lt;div class=&quot;message-bubble&quot;&gt;</span><br><span class=\"line\">            &lt;div class=&quot;message-content&quot;&gt;&#123;&#123; msg.content &#125;&#125;&lt;/div&gt;</span><br><span class=\"line\">            &lt;div class=&quot;message-time&quot;&gt;&#123;&#123; formatTime(msg.time) &#125;&#125;&lt;/div&gt;</span><br><span class=\"line\">          &lt;/div&gt;</span><br><span class=\"line\">          &lt;div class=&quot;avatar user-avatar&quot;&gt;</span><br><span class=\"line\">            &lt;div class=&quot;avatar-placeholder&quot;&gt;我&lt;/div&gt;</span><br><span class=\"line\">          &lt;/div&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;!-- 输入区域 --&gt;</span><br><span class=\"line\">    &lt;div class=&quot;chat-input-container&quot;&gt;</span><br><span class=\"line\">      &lt;div class=&quot;chat-input&quot;&gt;</span><br><span class=\"line\">        &lt;textarea v-model=&quot;inputMessage&quot; @keydown.enter.prevent=&quot;sendMessage&quot; placeholder=&quot;请输入消息...&quot; class=&quot;input-box&quot;</span><br><span class=\"line\">          :disabled=&quot;connectionStatus === &#x27;connecting&#x27;&quot;&gt;&lt;/textarea&gt;</span><br><span class=\"line\">        &lt;button @click=&quot;sendMessage&quot; class=&quot;send-button&quot;</span><br><span class=\"line\">          :disabled=&quot;connectionStatus === &#x27;connecting&#x27; || !inputMessage.trim()&quot;&gt;发送&lt;/button&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">  &lt;/div&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script setup&gt;</span><br><span class=\"line\">import &#123; ref, reactive, onMounted, nextTick, watch, computed &#125; from &#x27;vue&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">const props = defineProps(&#123;</span><br><span class=\"line\">  messages: &#123;</span><br><span class=\"line\">    type: Array,</span><br><span class=\"line\">    default: () =&gt; []</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  connectionStatus: &#123;</span><br><span class=\"line\">    type: String,</span><br><span class=\"line\">    default: &#x27;disconnected&#x27;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  aiType: &#123;</span><br><span class=\"line\">    type: String,</span><br><span class=\"line\">    default: &#x27;default&#x27;  // &#x27;love&#x27; 或 &#x27;super&#x27;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">const emit = defineEmits([&#x27;send-message&#x27;])</span><br><span class=\"line\"></span><br><span class=\"line\">const inputMessage = ref(&#x27;&#x27;)</span><br><span class=\"line\">const messagesContainer = ref(null)</span><br><span class=\"line\"></span><br><span class=\"line\">// 发送消息</span><br><span class=\"line\">const sendMessage = () =&gt; &#123;</span><br><span class=\"line\">  if (!inputMessage.value.trim()) return</span><br><span class=\"line\"></span><br><span class=\"line\">  emit(&#x27;send-message&#x27;, inputMessage.value)</span><br><span class=\"line\">  inputMessage.value = &#x27;&#x27;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// 格式化时间</span><br><span class=\"line\">const formatTime = (timestamp) =&gt; &#123;</span><br><span class=\"line\">  const date = new Date(timestamp)</span><br><span class=\"line\">  return date.toLocaleTimeString(&#x27;zh-CN&#x27;, &#123; hour: &#x27;2-digit&#x27;, minute: &#x27;2-digit&#x27; &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// 自动滚动到底部</span><br><span class=\"line\">const scrollToBottom = async () =&gt; &#123;</span><br><span class=\"line\">  await nextTick()</span><br><span class=\"line\">  if (messagesContainer.value) &#123;</span><br><span class=\"line\">    messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// 监听消息变化与内容变化，自动滚动</span><br><span class=\"line\">watch(() =&gt; props.messages.length, () =&gt; &#123;</span><br><span class=\"line\">  scrollToBottom()</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">watch(() =&gt; props.messages.map(m =&gt; m.content).join(&#x27;&#x27;), () =&gt; &#123;</span><br><span class=\"line\">  scrollToBottom()</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">onMounted(() =&gt; &#123;</span><br><span class=\"line\">  scrollToBottom()</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;style scoped&gt;</span><br><span class=\"line\">.ai-avatar-fallback &#123;</span><br><span class=\"line\">  width: 100%;</span><br><span class=\"line\">  height: 100%;</span><br><span class=\"line\">  display: flex;</span><br><span class=\"line\">  align-items: center;</span><br><span class=\"line\">  justify-content: center;</span><br><span class=\"line\">  font-size: 18px;</span><br><span class=\"line\">  border-radius: 50%;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.love &#123;</span><br><span class=\"line\">  background: linear-gradient(45deg, #ff6b8b, #ff8e8e);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.chat-container &#123;</span><br><span class=\"line\">  display: flex;</span><br><span class=\"line\">  flex-direction: column;</span><br><span class=\"line\">  height: 90vh;</span><br><span class=\"line\">  min-height: 600px;</span><br><span class=\"line\">  background-color: #f5f5f5;</span><br><span class=\"line\">  border-radius: 8px;</span><br><span class=\"line\">  overflow: hidden;</span><br><span class=\"line\">  position: relative;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.chat-messages &#123;</span><br><span class=\"line\">  flex: 1;</span><br><span class=\"line\">  overflow-y: auto;</span><br><span class=\"line\">  padding: 16px;</span><br><span class=\"line\">  padding-bottom: 80px;</span><br><span class=\"line\">  /* 为输入框留出空间 */</span><br><span class=\"line\">  display: flex;</span><br><span class=\"line\">  flex-direction: column;</span><br><span class=\"line\">  position: absolute;</span><br><span class=\"line\">  top: 0;</span><br><span class=\"line\">  left: 0;</span><br><span class=\"line\">  right: 0;</span><br><span class=\"line\">  bottom: 72px;</span><br><span class=\"line\">  /* 与输入框高度相匹配 */</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.message-wrapper &#123;</span><br><span class=\"line\">  margin-bottom: 16px;</span><br><span class=\"line\">  display: flex;</span><br><span class=\"line\">  flex-direction: column;</span><br><span class=\"line\">  width: 100%;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.message &#123;</span><br><span class=\"line\">  display: flex;</span><br><span class=\"line\">  align-items: flex-start;</span><br><span class=\"line\">  max-width: 85%;</span><br><span class=\"line\">  margin-bottom: 8px;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.user-message &#123;</span><br><span class=\"line\">  margin-left: auto;</span><br><span class=\"line\">  /* 用户消息靠右 */</span><br><span class=\"line\">  flex-direction: row;</span><br><span class=\"line\">  /* 正常顺序，先气泡后头像 */</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.ai-message &#123;</span><br><span class=\"line\">  margin-right: auto;</span><br><span class=\"line\">  /* AI消息靠左 */</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.avatar &#123;</span><br><span class=\"line\">  width: 36px;</span><br><span class=\"line\">  height: 36px;</span><br><span class=\"line\">  border-radius: 50%;</span><br><span class=\"line\">  overflow: hidden;</span><br><span class=\"line\">  flex-shrink: 0;</span><br><span class=\"line\">  display: flex;</span><br><span class=\"line\">  align-items: center;</span><br><span class=\"line\">  justify-content: center;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.user-avatar &#123;</span><br><span class=\"line\">  margin-left: 8px;</span><br><span class=\"line\">  /* 用户头像在右侧，左边距 */</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.ai-avatar &#123;</span><br><span class=\"line\">  margin-right: 8px;</span><br><span class=\"line\">  /* AI头像在左侧，右边距 */</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.avatar-placeholder &#123;</span><br><span class=\"line\">  width: 100%;</span><br><span class=\"line\">  height: 100%;</span><br><span class=\"line\">  display: flex;</span><br><span class=\"line\">  align-items: center;</span><br><span class=\"line\">  justify-content: center;</span><br><span class=\"line\">  background-color: #007bff;</span><br><span class=\"line\">  color: white;</span><br><span class=\"line\">  font-weight: bold;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.message-bubble &#123;</span><br><span class=\"line\">  padding: 12px;</span><br><span class=\"line\">  border-radius: 18px;</span><br><span class=\"line\">  position: relative;</span><br><span class=\"line\">  word-wrap: break-word;</span><br><span class=\"line\">  min-width: 100px;</span><br><span class=\"line\">  /* 最小宽度 */</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.user-message .message-bubble &#123;</span><br><span class=\"line\">  background-color: #007bff;</span><br><span class=\"line\">  color: white;</span><br><span class=\"line\">  border-bottom-right-radius: 4px;</span><br><span class=\"line\">  text-align: left;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.ai-message .message-bubble &#123;</span><br><span class=\"line\">  background-color: #e9e9eb;</span><br><span class=\"line\">  color: #333;</span><br><span class=\"line\">  border-bottom-left-radius: 4px;</span><br><span class=\"line\">  text-align: left;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.message-content &#123;</span><br><span class=\"line\">  font-size: 16px;</span><br><span class=\"line\">  line-height: 1.5;</span><br><span class=\"line\">  white-space: pre-wrap;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.message-time &#123;</span><br><span class=\"line\">  font-size: 12px;</span><br><span class=\"line\">  opacity: 0.7;</span><br><span class=\"line\">  margin-top: 4px;</span><br><span class=\"line\">  text-align: right;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.chat-input-container &#123;</span><br><span class=\"line\">  position: absolute;</span><br><span class=\"line\">  bottom: 0;</span><br><span class=\"line\">  left: 0;</span><br><span class=\"line\">  right: 0;</span><br><span class=\"line\">  background-color: white;</span><br><span class=\"line\">  border-top: 1px solid #e0e0e0;</span><br><span class=\"line\">  z-index: 100;</span><br><span class=\"line\">  height: 72px;</span><br><span class=\"line\">  /* 固定高度 */</span><br><span class=\"line\">  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.chat-input &#123;</span><br><span class=\"line\">  display: flex;</span><br><span class=\"line\">  padding: 16px;</span><br><span class=\"line\">  height: 100%;</span><br><span class=\"line\">  box-sizing: border-box;</span><br><span class=\"line\">  align-items: center;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.input-box &#123;</span><br><span class=\"line\">  flex-grow: 1;</span><br><span class=\"line\">  border: 1px solid #ddd;</span><br><span class=\"line\">  border-radius: 20px;</span><br><span class=\"line\">  padding: 10px 16px;</span><br><span class=\"line\">  font-size: 16px;</span><br><span class=\"line\">  resize: none;</span><br><span class=\"line\">  min-height: 20px;</span><br><span class=\"line\">  max-height: 40px;</span><br><span class=\"line\">  /* 限制高度 */</span><br><span class=\"line\">  outline: none;</span><br><span class=\"line\">  transition: border-color 0.3s;</span><br><span class=\"line\">  overflow-y: auto;</span><br><span class=\"line\">  scrollbar-width: none;</span><br><span class=\"line\">  /* Firefox */</span><br><span class=\"line\">  -ms-overflow-style: none;</span><br><span class=\"line\">  /* IE &amp; Edge */</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">/* 隐藏Webkit浏览器的滚动条 */</span><br><span class=\"line\">.input-box::-webkit-scrollbar &#123;</span><br><span class=\"line\">  display: none;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.input-box:focus &#123;</span><br><span class=\"line\">  border-color: #007bff;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.send-button &#123;</span><br><span class=\"line\">  margin-left: 12px;</span><br><span class=\"line\">  background-color: #007bff;</span><br><span class=\"line\">  color: white;</span><br><span class=\"line\">  border: none;</span><br><span class=\"line\">  border-radius: 20px;</span><br><span class=\"line\">  padding: 0 20px;</span><br><span class=\"line\">  font-size: 16px;</span><br><span class=\"line\">  cursor: pointer;</span><br><span class=\"line\">  transition: background-color 0.3s;</span><br><span class=\"line\">  height: 40px;</span><br><span class=\"line\">  align-self: center;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.send-button:hover:not(:disabled) &#123;</span><br><span class=\"line\">  background-color: #0069d9;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.typing-indicator &#123;</span><br><span class=\"line\">  display: inline-block;</span><br><span class=\"line\">  animation: blink 0.7s infinite;</span><br><span class=\"line\">  margin-left: 2px;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@keyframes blink &#123;</span><br><span class=\"line\">  0% &#123;</span><br><span class=\"line\">    opacity: 0;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  50% &#123;</span><br><span class=\"line\">    opacity: 1;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  100% &#123;</span><br><span class=\"line\">    opacity: 0;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.input-box:disabled,</span><br><span class=\"line\">.send-button:disabled &#123;</span><br><span class=\"line\">  opacity: 0.6;</span><br><span class=\"line\">  cursor: not-allowed;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">/* 响应式设计 */</span><br><span class=\"line\">@media (max-width: 768px) &#123;</span><br><span class=\"line\">  .message &#123;</span><br><span class=\"line\">    max-width: 95%;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .message-content &#123;</span><br><span class=\"line\">    font-size: 15px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .chat-input &#123;</span><br><span class=\"line\">    padding: 12px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .input-box &#123;</span><br><span class=\"line\">    padding: 8px 12px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .send-button &#123;</span><br><span class=\"line\">    padding: 0 15px;</span><br><span class=\"line\">    font-size: 14px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@media (max-width: 480px) &#123;</span><br><span class=\"line\">  .avatar &#123;</span><br><span class=\"line\">    width: 32px;</span><br><span class=\"line\">    height: 32px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .message-bubble &#123;</span><br><span class=\"line\">    padding: 10px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .message-content &#123;</span><br><span class=\"line\">    font-size: 14px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .chat-input-container &#123;</span><br><span class=\"line\">    height: 64px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .chat-messages &#123;</span><br><span class=\"line\">    bottom: 64px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">/* 新增：不同类型消息的样式 */</span><br><span class=\"line\">.ai-answer &#123;</span><br><span class=\"line\">  animation: fadeIn 0.3s ease-in-out;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.ai-final &#123;</span><br><span class=\"line\">  /* 最终回答，可以有不同的样式，例如边框高亮等 */</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.ai-error &#123;</span><br><span class=\"line\">  opacity: 0.7;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.user-question &#123;</span><br><span class=\"line\">  /* 用户提问的特殊样式 */</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">/* 连续消息气泡样式 */</span><br><span class=\"line\">.ai-message+.ai-message &#123;</span><br><span class=\"line\">  margin-top: 4px;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.ai-message+.ai-message .avatar &#123;</span><br><span class=\"line\">  visibility: hidden;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.ai-message+.ai-message .message-bubble &#123;</span><br><span class=\"line\">  border-top-left-radius: 10px;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/style&gt; </span><br></pre></td></tr></table></figure>\n\n<p>好了，现在能直接在你选择的页面使用了，在你需要的页面直接复制下面的代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script setup&gt;</span><br><span class=\"line\">import &#123; ref, onMounted, onBeforeUnmount &#125; from &#x27;vue&#x27;</span><br><span class=\"line\">import &#123; getFluxData &#125; from &#x27;./api/index.js&#x27;</span><br><span class=\"line\">import ChatRoom from &#x27;./components/ChatRoom.vue&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">const messages = ref([])</span><br><span class=\"line\">const chatId = ref(&#x27;&#x27;)</span><br><span class=\"line\">const connectionStatus = ref(&#x27;disconnected&#x27;)</span><br><span class=\"line\">let eventSource = null</span><br><span class=\"line\"></span><br><span class=\"line\">// 生成随机会话ID</span><br><span class=\"line\">const generateChatId = () =&gt; &#123;</span><br><span class=\"line\">  return &#x27;love_&#x27; + Math.random().toString(36).substring(2, 10)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// 添加消息到列表</span><br><span class=\"line\">const addMessage = (content, isUser) =&gt; &#123;</span><br><span class=\"line\">  messages.value.push(&#123;</span><br><span class=\"line\">    content,</span><br><span class=\"line\">    isUser,</span><br><span class=\"line\">    time: new Date().getTime()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">// 发送消息</span><br><span class=\"line\">const sendMessage = (message) =&gt; &#123;</span><br><span class=\"line\">  addMessage(message, true)</span><br><span class=\"line\"></span><br><span class=\"line\">  // 连接SSE</span><br><span class=\"line\">  if (eventSource) &#123;</span><br><span class=\"line\">    eventSource.close()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  // 创建一个空的AI回复消息</span><br><span class=\"line\">  const aiMessageIndex = messages.value.length</span><br><span class=\"line\">  addMessage(&#x27;&#x27;, false)</span><br><span class=\"line\"></span><br><span class=\"line\">  connectionStatus.value = &#x27;connecting&#x27;</span><br><span class=\"line\">  eventSource = getFluxData(message, chatId.value)</span><br><span class=\"line\"></span><br><span class=\"line\">  // 监听SSE消息</span><br><span class=\"line\">  eventSource.onmessage = (event) =&gt; &#123;</span><br><span class=\"line\">    const data = event.data</span><br><span class=\"line\">    console.log(data);</span><br><span class=\"line\">    if (data &amp;&amp; data !== &#x27;done&#x27;) &#123;</span><br><span class=\"line\">      // 更新最新的AI消息内容，而不是创建新消息</span><br><span class=\"line\">      if (aiMessageIndex &lt; messages.value.length) &#123;</span><br><span class=\"line\">        messages.value[aiMessageIndex].content += data</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    if (data === &#x27;done&#x27;) &#123;</span><br><span class=\"line\">      connectionStatus.value = &#x27;disconnected&#x27;</span><br><span class=\"line\">      eventSource.close()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  // 监听SSE错误</span><br><span class=\"line\">  eventSource.onerror = (error) =&gt; &#123;</span><br><span class=\"line\">    console.error(&#x27;SSE Error:&#x27;, error)</span><br><span class=\"line\">    connectionStatus.value = &#x27;error&#x27;</span><br><span class=\"line\">    eventSource.close()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// 页面加载时添加欢迎消息</span><br><span class=\"line\">onMounted(() =&gt; &#123;</span><br><span class=\"line\">  // 生成聊天ID</span><br><span class=\"line\">  chatId.value = generateChatId()</span><br><span class=\"line\"></span><br><span class=\"line\">  // 添加欢迎消息</span><br><span class=\"line\">  addMessage(&#x27;欢迎来到AI恋爱大师，请告诉我你的恋爱问题，我会尽力给予帮助和建议。&#x27;, false)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">// 组件销毁前关闭SSE连接</span><br><span class=\"line\">onBeforeUnmount(() =&gt; &#123;</span><br><span class=\"line\">  if (eventSource) &#123;</span><br><span class=\"line\">    eventSource.close()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;template&gt;</span><br><span class=\"line\">  &lt;div class=&quot;love-master-container&quot;&gt;</span><br><span class=\"line\">    &lt;div class=&quot;header&quot;&gt;</span><br><span class=\"line\">      &lt;h1 class=&quot;title&quot;&gt;AI大师&lt;/h1&gt;</span><br><span class=\"line\">      &lt;div class=&quot;chat-id&quot;&gt;会话ID: &#123;&#123; chatId &#125;&#125;&lt;/div&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;div class=&quot;content-wrapper&quot;&gt;</span><br><span class=\"line\">      &lt;div class=&quot;chat-area&quot;&gt;</span><br><span class=\"line\">        &lt;ChatRoom :messages=&quot;messages&quot; :connection-status=&quot;connectionStatus&quot; ai-type=&quot;love&quot; @send-message=&quot;sendMessage&quot; /&gt;</span><br><span class=\"line\">      &lt;/div&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">  &lt;/div&gt;</span><br><span class=\"line\">&lt;/template&gt;</span><br><span class=\"line\">&lt;style scoped&gt;</span><br><span class=\"line\">.love-master-container &#123;</span><br><span class=\"line\">  display: flex;</span><br><span class=\"line\">  flex-direction: column;</span><br><span class=\"line\">  min-height: 100vh;</span><br><span class=\"line\">  background-color: #fff9f9;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.header &#123;</span><br><span class=\"line\">  display: flex;</span><br><span class=\"line\">  justify-content: space-between;</span><br><span class=\"line\">  align-items: center;</span><br><span class=\"line\">  padding: 16px 24px;</span><br><span class=\"line\">  background-color: #ff6b8b;</span><br><span class=\"line\">  color: white;</span><br><span class=\"line\">  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);</span><br><span class=\"line\">  position: sticky;</span><br><span class=\"line\">  top: 0;</span><br><span class=\"line\">  z-index: 10;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.back-button:hover &#123;</span><br><span class=\"line\">  opacity: 0.8;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.back-button:before &#123;</span><br><span class=\"line\">  content: &#x27;←&#x27;;</span><br><span class=\"line\">  margin-right: 8px;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.title &#123;</span><br><span class=\"line\">  font-size: 20px;</span><br><span class=\"line\">  font-weight: bold;</span><br><span class=\"line\">  margin: 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.chat-id &#123;</span><br><span class=\"line\">  font-size: 14px;</span><br><span class=\"line\">  opacity: 0.8;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.content-wrapper &#123;</span><br><span class=\"line\">  display: flex;</span><br><span class=\"line\">  flex-direction: column;</span><br><span class=\"line\">  flex: 1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.chat-area &#123;</span><br><span class=\"line\">  flex: 1;</span><br><span class=\"line\">  padding: 16px;</span><br><span class=\"line\">  overflow: hidden;</span><br><span class=\"line\">  position: relative;</span><br><span class=\"line\">  /* 设置最小高度确保内容显示正常 */</span><br><span class=\"line\">  min-height: calc(100vh - 56px - 180px);</span><br><span class=\"line\">  /* 100vh减去头部高度和页脚高度 */</span><br><span class=\"line\">  margin-bottom: 16px;</span><br><span class=\"line\">  /* 为页脚留出空间 */</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">/* 响应式样式 */</span><br><span class=\"line\">@media (max-width: 768px) &#123;</span><br><span class=\"line\">  .header &#123;</span><br><span class=\"line\">    padding: 12px 16px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .title &#123;</span><br><span class=\"line\">    font-size: 18px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .chat-id &#123;</span><br><span class=\"line\">    font-size: 12px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .chat-area &#123;</span><br><span class=\"line\">    padding: 12px;</span><br><span class=\"line\">    min-height: calc(100vh - 48px - 160px);</span><br><span class=\"line\">    /* 调整计算值 */</span><br><span class=\"line\">    margin-bottom: 12px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">@media (max-width: 480px) &#123;</span><br><span class=\"line\">  .header &#123;</span><br><span class=\"line\">    padding: 10px 12px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .back-button &#123;</span><br><span class=\"line\">    font-size: 14px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .title &#123;</span><br><span class=\"line\">    font-size: 16px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .chat-id &#123;</span><br><span class=\"line\">    display: none;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .chat-area &#123;</span><br><span class=\"line\">    padding: 8px;</span><br><span class=\"line\">    min-height: calc(100vh - 42px - 150px);</span><br><span class=\"line\">    /* 再次调整计算值 */</span><br><span class=\"line\">    margin-bottom: 8px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/style&gt; </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-2-后端\"><a href=\"#6-2-后端\" class=\"headerlink\" title=\"6.2 后端\"></a>6.2 后端</h2><p>后端采用springboot</p>\n<p>首先是依赖</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span><br><span class=\"line\">&lt;project xmlns=<span class=\"string\">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> xmlns:xsi=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class=\"line\">         xsi:schemaLocation=<span class=\"string\">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class=\"line\">    &lt;modelVersion&gt;<span class=\"number\">4.0</span><span class=\"number\">.0</span>&lt;/modelVersion&gt;</span><br><span class=\"line\">    &lt;parent&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;<span class=\"number\">3.3</span><span class=\"number\">.8</span>&lt;/version&gt;</span><br><span class=\"line\">        &lt;relativePath/&gt;</span><br><span class=\"line\">    &lt;/parent&gt;</span><br><span class=\"line\">    &lt;groupId&gt;com.azer&lt;/groupId&gt;</span><br><span class=\"line\">    &lt;artifactId&gt;demo&lt;/artifactId&gt;</span><br><span class=\"line\">    &lt;version&gt;<span class=\"number\">0.0</span><span class=\"number\">.1</span>-SNAPSHOT&lt;/version&gt;</span><br><span class=\"line\">    &lt;name&gt;demo&lt;/name&gt;</span><br><span class=\"line\">    &lt;description&gt;demo&lt;/description&gt;</span><br><span class=\"line\">    &lt;url/&gt;</span><br><span class=\"line\">    &lt;licenses&gt;</span><br><span class=\"line\">        &lt;license/&gt;</span><br><span class=\"line\">    &lt;/licenses&gt;</span><br><span class=\"line\">    &lt;developers&gt;</span><br><span class=\"line\">        &lt;developer/&gt;</span><br><span class=\"line\">    &lt;/developers&gt;</span><br><span class=\"line\">    &lt;scm&gt;</span><br><span class=\"line\">        &lt;connection/&gt;</span><br><span class=\"line\">        &lt;developerConnection/&gt;</span><br><span class=\"line\">        &lt;tag/&gt;</span><br><span class=\"line\">        &lt;url/&gt;</span><br><span class=\"line\">    &lt;/scm&gt;</span><br><span class=\"line\">    &lt;properties&gt;</span><br><span class=\"line\">        &lt;maven.compiler.source&gt;<span class=\"number\">21</span>&lt;/maven.compiler.source&gt;</span><br><span class=\"line\">        &lt;maven.compiler.target&gt;<span class=\"number\">21</span>&lt;/maven.compiler.target&gt;</span><br><span class=\"line\">        &lt;project.build.sourceEncoding&gt;UTF-<span class=\"number\">8</span>&lt;/project.build.sourceEncoding&gt;</span><br><span class=\"line\">    &lt;/properties&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;dependencies&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;reactor-core&lt;/artifactId&gt;</span><br><span class=\"line\">            &lt;version&gt;<span class=\"number\">3.8</span><span class=\"number\">.0</span>&lt;/version&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;io.springboot.ai&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-ai-ollama&lt;/artifactId&gt;</span><br><span class=\"line\">            &lt;version&gt;<span class=\"number\">1.0</span><span class=\"number\">.3</span>&lt;/version&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;io.springboot.ai&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-ai-ollama-spring-boot-starter&lt;/artifactId&gt;</span><br><span class=\"line\">            &lt;version&gt;<span class=\"number\">1.0</span><span class=\"number\">.3</span>&lt;/version&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">        &lt;dependency&gt;</span><br><span class=\"line\">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class=\"line\">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class=\"line\">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class=\"line\">        &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;/dependencies&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/project&gt;</span><br></pre></td></tr></table></figure>\n\n<p>跨域配置</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.demo.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.context.annotation.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.config.annotation.CorsRegistry;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CorsConfig</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">WebMvcConfigurer</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">addCorsMappings</span><span class=\"params\">(CorsRegistry registry)</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        registry.addMapping(<span class=\"string\">&quot;/**&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">                .allowCredentials(<span class=\"literal\">true</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">                .allowedOriginPatterns(<span class=\"string\">&quot;*&quot;</span>)</span><br><span class=\"line\">                .allowedMethods(<span class=\"string\">&quot;GET&quot;</span>, <span class=\"string\">&quot;POST&quot;</span>, <span class=\"string\">&quot;PUT&quot;</span>, <span class=\"string\">&quot;DELETE&quot;</span>, <span class=\"string\">&quot;OPTIONS&quot;</span>)</span><br><span class=\"line\">                .allowedHeaders(<span class=\"string\">&quot;*&quot;</span>)</span><br><span class=\"line\">                .exposedHeaders(<span class=\"string\">&quot;*&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>测试接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.example.demo.service.SSEService;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.demo.sse.SSEMsgType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.example.demo.sse.SSEServer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.annotation.Resource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.http.MediaType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Flux;</span><br><span class=\"line\"><span class=\"keyword\">import</span> reactor.core.publisher.Mono;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@PROJECT</span>_NAME deepseek-doctor</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Author</span> Azer</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@DESCRIPTION</span></span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@Date</span> 2025-10-27 14:16</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/sse&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SSEController</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Resource</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> SSEService sseService;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@GetMapping(value = &quot;/chat/emitter&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> SseEmitter <span class=\"title function_\">doChatWithSseEmitter</span><span class=\"params\">(<span class=\"meta\">@RequestParam</span> String message, <span class=\"meta\">@RequestParam</span> String chatId)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 使用 SSEServer 创建连接并注册到全局管理器</span></span><br><span class=\"line\">        <span class=\"type\">SseEmitter</span> <span class=\"variable\">emitter</span> <span class=\"operator\">=</span> SSEServer.connect(chatId);</span><br><span class=\"line\"></span><br><span class=\"line\">        Flux&lt;String&gt; stringFlux = sseService.doChatWithSseEmitter(message, chatId);</span><br><span class=\"line\"></span><br><span class=\"line\">        stringFlux.subscribe(</span><br><span class=\"line\">                chunk -&gt; &#123;</span><br><span class=\"line\">                    SSEServer.sendMessage(chatId, chunk);</span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">                emitter::completeWithError,</span><br><span class=\"line\">                ()-&gt;&#123;</span><br><span class=\"line\">                    SSEServer.sendMessage(chatId, SSEMsgType.DONE.type);</span><br><span class=\"line\">                    SSEServer.stopServer(chatId);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> emitter;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>SSEServer</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.util.CollectionUtils;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Map;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.function.Consumer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Slf4j</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">SSEServer</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span>  <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Map&lt;String, SseEmitter&gt; sseClient=<span class=\"keyword\">new</span> <span class=\"title class_\">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> AtomicInteger onlineCounts=<span class=\"keyword\">new</span> <span class=\"title class_\">AtomicInteger</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> SseEmitter <span class=\"title function_\">connect</span><span class=\"params\">(String userId)</span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//设置超时时间，0代表永不过期，默认30秒，超时后会抛出异常</span></span><br><span class=\"line\">        SseEmitter sseEmitter=<span class=\"keyword\">new</span> <span class=\"title class_\">SseEmitter</span>(<span class=\"number\">0L</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//注册SSE的回调方法</span></span><br><span class=\"line\">        sseEmitter.onCompletion(completionCallback(userId));</span><br><span class=\"line\">        sseEmitter.onError(errorCallback(userId));</span><br><span class=\"line\">        sseEmitter.onTimeout(timeoutCallback(userId));</span><br><span class=\"line\"></span><br><span class=\"line\">        sseClient.put(userId,sseEmitter);</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;用户连接成功，userId:&#123;&#125;&quot;</span>,userId);</span><br><span class=\"line\">        onlineCounts.getAndIncrement();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> sseEmitter;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Runnable <span class=\"title function_\">timeoutCallback</span><span class=\"params\">(String userId)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> () -&gt; &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;用户连接超时，userId:&#123;&#125;&quot;</span>,userId);</span><br><span class=\"line\">            removeConnection(userId);</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Consumer&lt;Throwable&gt; <span class=\"title function_\">errorCallback</span><span class=\"params\">(String userId)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Throwable -&gt; &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;用户连接异常，userId:&#123;&#125;&quot;</span>,userId);</span><br><span class=\"line\">            removeConnection(userId);</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span> SSE连接完成后的回调方法</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> userId</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span>  Runnable</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Runnable <span class=\"title function_\">completionCallback</span><span class=\"params\">(String userId)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> () -&gt; &#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;用户连接断开，userId:&#123;&#125;&quot;</span>,userId);</span><br><span class=\"line\">            removeConnection(userId);</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">removeConnection</span><span class=\"params\">(String userId)</span> &#123;</span><br><span class=\"line\">        sseClient.remove(userId);</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;用户连接已移除，userId:&#123;&#125;&quot;</span>,userId);</span><br><span class=\"line\">        onlineCounts.getAndDecrement();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"type\">int</span> <span class=\"title function_\">getOnlineCounts</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> onlineCounts.intValue();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span> 发送单条消息</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> userId</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> message</span></span><br><span class=\"line\"><span class=\"comment\">     * */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sendMessage</span><span class=\"params\">(String userId, String message)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(CollectionUtils.isEmpty(sseClient))&#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;当前无连接，请检查是否已断开或未建立连接！&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(sseClient.containsKey(userId))&#123;</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;用户已连接，开始发送消息，userId:&#123;&#125;&quot;</span>,userId);</span><br><span class=\"line\">            <span class=\"type\">SseEmitter</span> <span class=\"variable\">sseEmitter</span> <span class=\"operator\">=</span> sseClient.get(userId);</span><br><span class=\"line\">            sendEmitterMessage(sseEmitter,userId,message);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            log.warn(<span class=\"string\">&quot;用户未连接，请检查是否已断开或未建立连接！&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span> 使用SseEmitter发送消息</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> sseEmitter</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> userId</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> message</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sendEmitterMessage</span><span class=\"params\">(SseEmitter sseEmitter, String userId, String message)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            sseEmitter.send(message);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">&quot;sse发送消息异常：&#123;&#125;&quot;</span>,e.getMessage());</span><br><span class=\"line\">            removeConnection(userId);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span> 主动切断，停止服务</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> userId</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">stopServer</span><span class=\"params\">(String userId)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(CollectionUtils.isEmpty(sseClient))&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"type\">SseEmitter</span> <span class=\"variable\">sseEmitter</span> <span class=\"operator\">=</span> sseClient.get(userId);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(sseEmitter!=<span class=\"literal\">null</span>)&#123;</span><br><span class=\"line\">            sseEmitter.complete();</span><br><span class=\"line\">            log.info(<span class=\"string\">&quot;连接关闭成功，userId:&#123;&#125;&quot;</span>,userId);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            log.warn(<span class=\"string\">&quot;当前连接无需关闭,请不要重复操作，userId:&#123;&#125;&quot;</span>,userId);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@Description</span> 发送所有用户消息</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> message</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">sendMessageToAllUsers</span><span class=\"params\">(String message)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(CollectionUtils.isEmpty(sseClient))&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        sseClient.forEach((userId, sseEmitter) -&gt; &#123;</span><br><span class=\"line\">            sendEmitterMessage(sseEmitter,userId,message);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>类型</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">enum</span> <span class=\"title class_\">SSEMsgType</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    MESSAGE(<span class=\"string\">&quot;message&quot;</span>,<span class=\"string\">&quot;单次发送的普通消息&quot;</span>),</span><br><span class=\"line\">    ADD(<span class=\"string\">&quot;add&quot;</span>,<span class=\"string\">&quot;消息追加，用于流式stream推送&quot;</span>),</span><br><span class=\"line\">    FINISH(<span class=\"string\">&quot;finish&quot;</span>,<span class=\"string\">&quot;消息完成&quot;</span>),</span><br><span class=\"line\">    DONE(<span class=\"string\">&quot;done&quot;</span>,<span class=\"string\">&quot;消息完成，用于结束流式stream推送&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span>  String type;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">final</span>  String value;</span><br><span class=\"line\"></span><br><span class=\"line\">    SSEMsgType(String type, String value) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.type = type;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.value = value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>yml的配置</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">ai:</span></span><br><span class=\"line\">    <span class=\"attr\">ollama:</span></span><br><span class=\"line\">      <span class=\"attr\">base-url:</span> <span class=\"string\">http://localhost:11434</span></span><br><span class=\"line\">      <span class=\"attr\">chat:</span></span><br><span class=\"line\">        <span class=\"attr\">model:</span> <span class=\"string\">你自己ai的模型名称</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-3-测试\"><a href=\"#6-3-测试\" class=\"headerlink\" title=\"6.3 测试\"></a>6.3 测试</h2><p><img src=\"/post/SSE/image-20251114214923714.png\" alt=\"image-20251114214923714\"></p>\n<p><img src=\"/post/SSE/image-20251114215235010.png\" alt=\"image-20251114215235010\"></p>\n<p>能看到是顺利输出也不报错了，所以就成功实现了</p>\n","text":"一、什么是SSE？SSE为何突然爆火？你有没有想过，为什么 ChatGPT 的回答能逐字逐句地“流”出来？ 这一切的背后，都离不开一项关键技术——SSE（Ser...","permalink":"/post/SSE","photos":[],"count_time":{"symbolsCount":"40k","symbolsTime":"36 mins."},"categories":[{"name":"网络通信","slug":"网络通信","count":4,"path":"api/categories/网络通信.json"}],"tags":[{"name":"网络通信","slug":"网络通信","count":4,"path":"api/tags/网络通信.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFSSE%EF%BC%9FSSE%E4%B8%BA%E4%BD%95%E7%AA%81%E7%84%B6%E7%88%86%E7%81%AB%EF%BC%9F\"><span class=\"toc-text\">一、什么是SSE？SSE为何突然爆火？</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF-SSE%EF%BC%9F\"><span class=\"toc-text\">1.1、什么是 SSE？</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-2-SSE-Server-Sent-Events-%E8%AF%9E%E7%94%9F%E8%83%8C%E6%99%AF\"><span class=\"toc-text\">1.2 SSE (Server-Sent Events) 诞生背景</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%9F%AD%E8%BD%AE%E8%AF%A2%E3%80%81%E9%95%BF%E8%BD%AE%E8%AF%A2%E3%80%81Flash-%E3%80%81-WebSocket\"><span class=\"toc-text\">短轮询、长轮询、Flash 、 WebSocket</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#SSE-%E8%AF%9E%E7%94%9F%E7%9A%84%E6%A0%B8%E5%BF%83%E8%83%8C%E6%99%AF\"><span class=\"toc-text\">SSE 诞生的核心背景</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-3-SSE-%E5%8F%91%E5%B1%95%E5%8E%86%E7%A8%8B\"><span class=\"toc-text\">1.3 SSE 发展历程</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-4%E3%80%81SSE-%E7%9A%84%E4%B8%BB%E8%A6%81%E7%89%B9%E7%82%B9\"><span class=\"toc-text\">1.4、SSE 的主要特点</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BA%8C%EF%BC%9ASSE-%E5%87%BA%E6%9D%A520%E5%B9%B4%E6%89%8D%E4%B8%80%E5%A4%9C-%E7%88%86%E7%81%AB-%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%EF%BC%9F\"><span class=\"toc-text\">二：SSE 出来20年才一夜 爆火 ，为什么？</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E2%80%9C%E6%89%93%E5%AD%97%E6%9C%BA%E2%80%9D-%E5%BC%8F%E9%80%90-token-%E8%BE%93%E5%87%BA%EF%BC%9F\"><span class=\"toc-text\">2.1 什么是“打字机” 式逐 token 输出？</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-2-%E4%B8%BA%E4%BB%80%E4%B9%88-SSE-%E6%98%AF%E8%BF%99%E7%A7%8D%E6%A8%A1%E5%BC%8F%E7%9A%84%E2%80%9C%E5%A4%A9%E4%BD%9C%E4%B9%8B%E5%90%88%E2%80%9D%EF%BC%9F\"><span class=\"toc-text\">2.2 为什么 SSE 是这种模式的“天作之合”？</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%B8%89%E3%80%81SSE-%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86\"><span class=\"toc-text\">三、SSE 的工作原理</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3-1-%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6%E7%9A%84%E6%B5%81%E7%A8%8B%E5%9B%BE\"><span class=\"toc-text\">3.1 工作机制的流程图</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3-2%E3%80%81SSE-%E4%B8%8E%E5%85%B6%E4%BB%96%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94\"><span class=\"toc-text\">3.2、SSE 与其他通信方式对比</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3-3-SSE-%E7%9A%84%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF\"><span class=\"toc-text\">3.3 SSE 的适用场景</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%9B%9B%E3%80%81sse-%E5%AE%A2%E6%88%B7%E7%AB%AF-API-%E8%AF%A6%E8%A7%A3\"><span class=\"toc-text\">四、sse 客户端 API 详解</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4-1%E3%80%81%E8%AE%A4%E8%AF%86-%E6%B5%8F%E8%A7%88%E5%99%A8-EventSource%E5%AF%B9%E8%B1%A1\"><span class=\"toc-text\">4.1、认识 浏览器 EventSource对象</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%85%BC%E5%AE%B9%E6%80%A7%E6%A3%80%E6%B5%8B\"><span class=\"toc-text\">浏览器兼容性检测</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA%E8%BF%9E%E6%8E%A5\"><span class=\"toc-text\">创建连接</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BF%9E%E6%8E%A5%E7%8A%B6%E6%80%81%EF%BC%88readyState%EF%BC%89\"><span class=\"toc-text\">连接状态（readyState）</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4-2%E3%80%81%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95\"><span class=\"toc-text\">4.2、基本使用方法</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%EF%BC%9Aopen%E4%BA%8B%E4%BB%B6\"><span class=\"toc-text\">连接建立：open事件</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE%EF%BC%9Amessage%E4%BA%8B%E4%BB%B6\"><span class=\"toc-text\">接收数据：message事件</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BF%9E%E6%8E%A5%E9%94%99%E8%AF%AF%EF%BC%9Aerror%E4%BA%8B%E4%BB%B6\"><span class=\"toc-text\">连接错误：error事件</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%85%B3%E9%97%AD%E8%BF%9E%E6%8E%A5%EF%BC%9Aclose-%E6%96%B9%E6%B3%95\"><span class=\"toc-text\">关闭连接：close()方法</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4-3%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BA%8B%E4%BB%B6\"><span class=\"toc-text\">4.3、自定义事件</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BA%94%E3%80%81SSE%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%9E%E7%8E%B0%EF%BC%9A%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E4%B8%8E%E8%A7%84%E5%88%99\"><span class=\"toc-text\">五、SSE服务器实现：数据格式与规则</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#5-1-HTTP-%E5%A4%B4%E4%BF%A1%E6%81%AF%E8%A6%81%E6%B1%82\"><span class=\"toc-text\">5.1 HTTP 头信息要求</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#5-2-%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E6%A0%BC%E5%BC%8F\"><span class=\"toc-text\">5.2 数据传输格式</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#5-3-%E6%A0%B8%E5%BF%83%E5%AD%97%E6%AE%B5%E8%AF%B4%E6%98%8E\"><span class=\"toc-text\">5.3 核心字段说明</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-data%E5%AD%97%E6%AE%B5%EF%BC%9A%E6%B6%88%E6%81%AF%E5%86%85%E5%AE%B9\"><span class=\"toc-text\">1. data字段：消息内容</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-event%E5%AD%97%E6%AE%B5%EF%BC%9A%E6%8C%87%E5%AE%9A%E4%BA%8B%E4%BB%B6%E7%B1%BB%E5%9E%8B\"><span class=\"toc-text\">2. event字段：指定事件类型</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-id%E5%AD%97%E6%AE%B5%EF%BC%9A%E6%B6%88%E6%81%AF%E6%A0%87%E8%AF%86\"><span class=\"toc-text\">3. id字段：消息标识</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4-retry%E5%AD%97%E6%AE%B5%EF%BC%9A%E9%87%8D%E8%BF%9E%E9%97%B4%E9%9A%94\"><span class=\"toc-text\">4. retry字段：重连间隔</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BF%9D%E6%8C%81%E8%BF%9E%E6%8E%A5%E7%A4%BA%E4%BE%8B\"><span class=\"toc-text\">5. 服务器保持连接示例</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#5-4-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B\"><span class=\"toc-text\">5.4 服务器发送流程</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%85%AD%E3%80%81SSE%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5\"><span class=\"toc-text\">六、SSE最佳实践</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#6-1-%E5%89%8D%E7%AB%AF\"><span class=\"toc-text\">6.1 前端</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#6-2-%E5%90%8E%E7%AB%AF\"><span class=\"toc-text\">6.2 后端</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#6-3-%E6%B5%8B%E8%AF%95\"><span class=\"toc-text\">6.3 测试</span></a></li></ol></li></ol>","author":{"name":"Azer","slug":"blog-author","avatar":"/images/avatar.png","link":"/","description":"<span style='font-size:30px;background:linear-gradient(90deg,#00c6ff,#0072ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;'>怀民亦未寝</span><span style='font-size:30px;'>💕</span>","socials":{"github":"https://github.com/azer-2025","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/weixin_52541129?type=blog","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://space.bilibili.com/1764589563?spm_id_from=333.1007.0.0"},"gitee":{"icon":"/svg/gitee.svg","link":"https://gitee.com/azzzer"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"WebSocket","uid":"2db4480eaccada3af93deb830f4fe8c2","slug":"WebSocket","date":"2025-11-16T03:28:45.000Z","updated":"2025-11-26T13:49:12.209Z","comments":true,"path":"api/articles/WebSocket.json","keywords":"VUE、Python、JAVA","cover":"/medias/WebSocket.png","text":"一、 简介1.1 什么是 WebSocketWebSocket是一种 协议，用于在Web应用程序和服务器之间建立实时、双向的通信连接。它通过一个单一的TCP连接...","permalink":"/post/WebSocket","photos":[],"count_time":{"symbolsCount":"14k","symbolsTime":"13 mins."},"categories":[{"name":"网络通信","slug":"网络通信","count":4,"path":"api/categories/网络通信.json"}],"tags":[{"name":"网络通信","slug":"网络通信","count":4,"path":"api/tags/网络通信.json"}],"author":{"name":"Azer","slug":"blog-author","avatar":"/images/avatar.png","link":"/","description":"<span style='font-size:30px;background:linear-gradient(90deg,#00c6ff,#0072ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;'>怀民亦未寝</span><span style='font-size:30px;'>💕</span>","socials":{"github":"https://github.com/azer-2025","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/weixin_52541129?type=blog","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://space.bilibili.com/1764589563?spm_id_from=333.1007.0.0"},"gitee":{"icon":"/svg/gitee.svg","link":"https://gitee.com/azzzer"}}}}},"next_post":{"title":"VueUse Head","uid":"0c1a486237cc0ded727f0473b33c5eab","slug":"VueUse-Head","date":"2025-11-13T05:29:50.000Z","updated":"2025-11-13T05:31:25.860Z","comments":true,"path":"api/articles/VueUse-Head.json","keywords":"VUE、Python、JAVA","cover":"/medias/VueUse_Head.png","text":"VueUse Head 使用教程项目 介绍VueUse Head 是一个用于管理 Vue 3 应用中 <head> 标签内容的库。它允许开发者动态地设置和更新文...","permalink":"/post/VueUse-Head","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[{"name":"前端","slug":"前端","count":2,"path":"api/categories/前端.json"}],"tags":[{"name":"插件","slug":"插件","count":4,"path":"api/tags/插件.json"},{"name":"vue","slug":"vue","count":2,"path":"api/tags/vue.json"}],"author":{"name":"Azer","slug":"blog-author","avatar":"/images/avatar.png","link":"/","description":"<span style='font-size:30px;background:linear-gradient(90deg,#00c6ff,#0072ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;'>怀民亦未寝</span><span style='font-size:30px;'>💕</span>","socials":{"github":"https://github.com/azer-2025","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/weixin_52541129?type=blog","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://space.bilibili.com/1764589563?spm_id_from=333.1007.0.0"},"gitee":{"icon":"/svg/gitee.svg","link":"https://gitee.com/azzzer"}}}}}}